---
# xremap - key remapping for Linux

- name: Check if xremap is installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.cargo/bin/xremap"
  register: xremap_binary

- name: Install xremap from crates.io
  ansible.builtin.command: cargo install xremap --features gnome
  when: not xremap_binary.stat.exists
  become: false

- name: Add user to input group
  ansible.builtin.user:
    name: "{{ ansible_env.USER }}"
    groups: input
    append: true
  become: true

- name: Ensure xremap config directory exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config/xremap"
    state: directory
    mode: '0755'
  become: false

- name: Create xremap systemd service
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.config/systemd/user/xremap.service"
    mode: '0644'
    content: |
      [Unit]
      Description=Start xremap with custom configuration
      Documentation=https://github.com/xremap/xremap

      [Service]
      Type=simple
      Environment=PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/bin:{{ ansible_env.HOME }}/.cargo/bin
      Environment=DISPLAY=:0
      Environment=HOME={{ ansible_env.HOME }}
      ExecStart={{ ansible_env.HOME }}/.cargo/bin/xremap --watch {{ ansible_env.HOME }}/.config/xremap/config.yml
      Restart=always

      [Install]
      WantedBy=default.target
  become: false

- name: Reload systemd user daemon
  ansible.builtin.systemd:
    daemon_reload: true
    scope: user
  become: false

- name: Enable xremap service
  ansible.builtin.systemd:
    name: xremap
    enabled: true
    scope: user
  become: false
